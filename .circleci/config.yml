version: 2.1

jobs:
  run_ray_example:
    docker:
      - image: gueraf/rules_ray_py_test:latest
    steps:
      - run:
          name: "examples/py_ray_hello_world:hello_world_ray_job"
          command: |
            bazelisk build examples/py_ray_hello_world:hello_world_ray_job && \
            until ray status | grep -q "1 node_"; do sleep 1; done && \
            timeout 5m bazelisk run examples/py_ray_hello_world:hello_world_ray_job -- --wait=true

workflows:
  version: 2
  main:
    jobs:
      - run_ray_example